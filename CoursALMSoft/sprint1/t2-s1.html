<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"><html lang="en-US">  <head>    <meta http-equiv="content-type" content="text/html; charset=utf-8">    <title>Workshop: Programming Basics</title>    <meta name="CHANGEDBY" content="Pr. Olivier Gruber">    <link rel="stylesheet" href="../style.css" type="text/css">    <script src="../common.js"></script>    <link rel="stylesheet" href="../highlight.js/styles/default.css">    <script src="../highlight.js/highlight.pack.js"></script>    <script>hljs.initHighlightingOnLoad();</script>  </head>  <body onload="shellOnLoad()">    <script>      function shellOnLoad() {        multiLang();        /*hljs.initHighlightingOnLoad(); */      }      </script>    <div id="outer-container">      <div id="header">        <div id="logo"> <img src="../logo_uga.png" alt="Université Grenoble-Alpes"            height="100"            border="0">          <img src="../logo_reseau_polytech.gif" alt="Polytech" height="80" border="0">        </div>        <div id="top-links"> <a href="../index.html">Home</a> </div>      </div>      <div id="inner-container">        <h1>Bases de l'assembleur<br>        </h1>        <h2>Task2 -- Une première fonction</h2>        <h3>Step1 -- Définition et utilisation d'une fonction (ARM)<br>        </h3>        <br>        <br>        <p>Ce serait bien de pouvoir définir une fonction de division qui peut          être appelée avec différentes valeurs. <br>        </p>        <p>Une fonction, en programmation, est un morceau de code qui calcule          une ou plusieurs valeurs de sortie, avec une ou plusieurs valeurs          d'entrée. En ce sens, il est proche du concept de fonctions en          mathématiques. <br>        </p>        <p>La fonction suivante, appelée <span style="font-style: italic;">div</span>,          prend deux valeurs d'entrée, le dividende et le diviseur, et calcule          deux valeurs de sortie; le quotient et le reste. </p>        <pre>	  div(dividend,divisor) = (quotient,remainder)<br>	  <br>	  example: div(9,4) = (2,1) <br>	</pre>        <p>Vous venez d'écrire le code de cette fonction. Les deux valeurs          d'entrée sont données dans les registres r0 (dividende) et r1          (diviseur). Les deux valeurs de sortie sont données dans les registres          r2 (quotient) et <i>r0</i> (reste).</p>        <p> Ce qui nous manque, c'est un mécanisme pour appeler la fonction. On          pourrait le faire à l'aide d'un simple branchement comme ceci:</p>        <pre><code class="arm">.global _start<br>_start:<br>	mov r0, #9	 <br>        mov r1, #4<br>        b _div       // first call to _div(9,4)<br>	mov r0, #3	 <br>        mov r1, #4<br>        b _div       // first call to _div(3,4)<br>        b _halt</code></pre>        <p>Le problème est comment revenir au bon endroit à la fin de          l'exécution de la division ? En effet, ce n'est pas le même endroit au          premier coup et au deuxième.</p>        <p>Il faut revenir une fois après le premier <span style="font-style: italic;">b            _div</span> (à l'instruction <span style="font-style: italic;">mov            r0,#3</span>), une fois après le deuxième <span style="font-style: italic;">b            _div</span> (à l'intruction <span style="font-style: italic;">b            _halt</span>)</p>        <p> Nous inventons l'intruction <span style="font-weight: bold; font-style: italic;">branch-and-link</span>          (mnémonique <em><span style="font-weight: bold;">bl</span>)</em> qui          va permettre de revenir au bon endroit après chaque appel.</p>        <p><br>        </p>        <p> </p>        <pre><code class="arm">.global _start_start:	mov r0, #9	         mov r1, #4        bl _div       // first call to _div(9,4)	mov r0, #3	         mov r1, #4        bl _div       // first call to _div(3,4)        b _halt_div:        // Add your division code here..._ret:        mov pc, lr_halt:        b _halt              </code></pre>        <p> Placez vous dans le répertoire <b><i>task2</i></b>.<br>          Dans le fichier <b>start.s</b>, insérez le code de division que vous          avez écrit dans la task1 à l'endroit indiqué.<br>          <b>Attention :</b> Ne copiez pas l'initialisation de <i><b>r0</b></i>          et <i><b>r1</b></i>. Cela est fait dans le <i>_start</i>. Copiez          uniquement la partie qui divise <i>r0</i> par <i>r1</i> et met le          résultat dans <i>r0 et r2.</i> </p>        <p> On va utiliser le debogueur pour comprendre comment fonctionne          l'instruction <i><b>branch-and-link</b> (<b>bl</b>)</i>. <br>          Mettez un point d'arrêt sur les étiquettes <i><b>_div</b></i> et <i><b>_ret</b></i>.        </p>        <p>Chaque fois que <i>gdb</i> s'arrête à <i><b>_ret</b></i>, regardez          la valeur du registre<i> <b>lr</b></i> (<i><b>r14</b></i>). Le retour          de la fonction est fait grâce à <i><b>mov pc, lr</b></i>. La          prochaine instruction exécutée après ce <i>move</i>, sera donc celle          se trouvant à l'adresse contenu dans <i><b>lr</b></i>. </p>        <p> Comment se fait-il que <b><i>lr</i></b> contienne la bonne adresse          quel que soit l'appel de la fonction?<br>          Lorsque le processeur exécute l'instruction <i><b>branch-and-link</b>            (<b>bl</b>)</i>, il enregistre dans le registre <i><b>lr</b></i>          l'adresse à laquelle l'exécution doit se poursuivre après l'arrêt de          la fonction appelée. Autrement dit, si l'instruction <i><b>bl</b></i>          est à l'adresse <b>0x10004</b>, le processeur placera dans <i><b>lr</b></i>          la valeur <b>0x10008</b>, l'instruction qui est immédiatement après          le <i><b>bl</b></i>.<br>          C'est pourquoi nous restaurons la valeur du registre <b><i>pc</i></b>          à partir de la valeur sauvegardée dans le registre <i><b>lr</b></i>.        </p>        <p>Vous venez d'assister à votre premier appel de fonction, de A à Z.<br>          <br>        </p>        <h3>Programmation modulaire<br>        </h3>        <span style="font-family: Arial,Serif;">Jusqu'à présent, nous avons          ajouté du code au seul fichier de notre projet: <span style="font-style: italic;">start.s</span>.          <br>          Nous allons diviser notre code source pour écrire des programmes plus          complexes. Pour ce faire, nous devons créer plus de fichiers sources          et intégrer leur gestion dans notre fichier <i>makefile</i>.<br>          Créez le fichier <span style="font-style: italic;">div.s</span>          suivant:<br>        </span>        <pre><code class="arm">/** A function that computes a quotient, from a dividend in r0* and a divisor in r1. The quotient is returned in r0 and the* remainder in r2.* Call this function using a branch-and-link.* Clobbered: r0,r2,lr*/.global _div_div:        // Add your division code here..._ret:        mov pc, lr	</code></pre>        <p>Notons que nous avons ajouté la ligne: </p>        <pre><code class="arm">.global _div	</code></pre>        <span style="font-family: Arial,Serif;">Elle indique aux outils que          l'étiquette <span style="font-style: italic;">_div</span> doit être          considérée comme une étiquette globale, connue partout, et pas          seulement localement pour ce fichier <span style="font-style: italic;">div.s</span>.          Ceci est important pour que le code du fichier <span style="font-style: italic;">start.s</span>          puisse appeler cette fonction.<br>          <br>          Maintenant, la partie la plus difficile, est de modifier le <span style="font-style: italic;">makefile</span>.          Voici le <i>makefile</i> modifié, pour compiler et composer à la fois          <i>start.s</i> et<i> div.s</i>. Les lignes à modifier sont données          ci-dessous:</span>        <pre><code>kernel.bin: start.o div.o 	$(TOOLCHAIN)-ld -T ldscript start.o div.o -o kernel.elf	$(TOOLCHAIN)-objcopy -O binary kernel.elf kernel.binstart.o: start.s 	$(TOOLCHAIN)-as -mcpu=arm926ej-s -gstabs+ start.s -o start.odiv.o: div.s Makefile 	$(TOOLCHAIN)-as -mcpu=arm926ej-s -gstabs+ div.s -o div.o	</code></pre>        <span style="font-family: Arial,Serif;">Notez que nous indiquons          maintenant que <span style="font-style: italic;">kernel.bin</span>          (le binaire chargé dans Qemu) dépend de <span style="font-style: italic;">start.o</span>          et de <span style="font-style: italic;">div.o</span>, c'est-à-dire          des fichiers objets résultant de la compilation des deux <span style="font-style: italic;">start.s</span>          et <span style="font-style: italic;">div.s</span>. Par conséquent,          nous ajoutons une règle pour dire comment compiler <span style="font-style: italic;">div.s</span>          (de façon identique à start.s).<br>          Recompilez à l'aide de ce nouveau makefile et essayez une exécution en          pas à pas.<br>          <br>          <br>        </span>        <h3>Step versus Next</h3>        <p>La commande de gdb <b><span style="font-style: italic;">stepi</span></b>          permet d'exécuter une instruction à la fois. Cependant, maintenant que          nous avons une fonction nous allons avoir envie de l'exécuter sans          s'arrêter sur les instructions internes à celle-ci. La commande pour          cela s'appelle <span style="font-style: italic; font-weight: bold;">nexti</span>          au lieu de <span style="font-style: italic;">stepi (</span>abréviation
          de <b><span style="font-style: italic;">si</span></b> et <b><span style="font-style: italic;">ni</span></b>).
          Supposons que votre code dans start.s ressemble à ceci: </p>        <pre><code class="arm">0x10000  .global _start0x10000  _start:0x10004          mov r0, #640x10008          mov r1, #50x1000C          bl _div0x10010          b halt0x10014  _halt:0x10018          b _halt	</code></pre>        <p>A <i>0x1000C</i>, nous aimerions pouvoir passer par-dessus l'appel,          en utilisant la commande <span style="font-style: italic;">nexti</span>          sous gdb, mais cela ne marche pas vraiment, nous sommes toujours en          train d'entrer dans la fonction <span style="font-style: italic;">_div</span>:        </p>        <textarea class="terminal" rows="6">  (gdb) nexti  _div () at div.s:10  (gdb) p _div  $2 = {&lt;text variable, no debug info&gt;} 0x10014 &lt;_div&gt;  (gdb)	</textarea>        <p>Si nous demandons à Gdb ce qu'il sait de <i>_div</i>, il nous          indique qu'il en sait très peu car il n'y a pas d'informations de          débogage. Nous avons demandé à nos outils de garder ces informations          de débogage (l'option <b><span style="font-style: italic;">-gstabs+</span></b>          dans le <span style="font-style: italic;">makefile</span>), mais il          semble que ce n'est pas disponible, pourquoi? Il nous manque deux          choses pour que Gdb s'y retrouve. <br>        </p>        <p>Premièrement, nous devons annoter notre source pour parler de notre          fonction <span style="font-style: italic;">_div</span>. En effet, les          outils ne peuvent pas lire dans notre esprit, nous devons dire aux          outils que le label<span style="font-style: italic;"> _div</span> est          une fonction: </p>        <pre><code class="arm">	.text	.align 2.global _div	.type _div,%function	.func _div,_div_div:	/* your code here */	mov pc,lr	.size	_div, .-_div	.endfunc 	</code></pre>        <p>Deuxièmement, nous devons avoir un pointeur de pile non nul. Il est          trop tôt pour expliquer réellement ce qu'est la pile et quel est le          rôle du pointeur de pile, mais le pointeur de pile (le registre <span            style="font-style: italic;">sp
            : r13)</span>, ne doit pas être nul. Tant que le registre <i>sp</i>          est nul, gdb n'est pas conforme à la commande <span style="font-style: italic;">nexti</span>.          Nous allons donc nous contenter de charger une valeur sans          signification dans le registre <span style="font-style: italic;">sp</span>.        </p>        <pre><code class="arm">  .global _start  _start:          mov sp, #0xFF            mov r0, #64          mov r1, #5          bl _div          b halt    _halt:          b _halt	</code></pre>        <p>Recompilez, lancez Qemu, puis Gdb. <br>        </p>        <p>Demandons à Gdb ce qu'il sait de notre fonction <span style="font-style: italic;">_div</span>:        </p>        <textarea class="terminal" rows="4">  (gdb) p _div  $1 = {void (void)} 0x10020 &lt;_div&gt;  (gdb)	</textarea> <span style="font-family: Arial,Serif;"><br>          <br>          Cela a l'air beaucoup mieux. Essayez maintenant d'utilisez <span style="font-style: italic;">nexti</span>          (ni) par opposition à <span style="font-style: italic;">stepi</span>          (si), et l'exécution passera par-dessus l'appel à la fonction <span style="font-style: italic;">_div</span>.<br>          <br>          Cool, on a déjà bien avancé !<br>          <br>          <h4>Astuce GDB bonus</h4>          <p> Il est possible de dire à GDB de sauter l'exécution à un label ou            une adresse particulière : <textarea class="terminal" rows="8">Pour sauter à un label :set $pc = labelPour sauter à une adresse spécifiqueset $pc = 0x10040</textarea></p>          <h3>Quelques exercices</h3>          <h4>1. Ecrivez un programme ARM selon la spéficication ci-dessous</h4>          <p> </p>          <ul>            <li>Une fonction qui prend en entrée un entier dans le paramètre <i>r0</i>              et retourne la factorielle de cet entier dans ce même registre<i>                r0</i>.</li>            <li>Appelez cette fonction comme nous l'avons fait pour la fonction              <i>div</i>.</li>          </ul>          Testez votre programme avec GDB.          <p></p>          <h4>2. Hello World</h4>          <p> Ecrire un programme qui affiche "<i>Hello World</i>" est un rite            de passage <b>obligatoire</b> lorsqu'on apprend un nouveau            language. C'est ce que vous allez faire maintenant ! </p>          <p> Le fichier <i><b>io.s</b></i> contient une fonction <i><b>_writec</b></i>            qui affiche un caractère codé en ASCII dans le terminal de qemu.<br>            Vous n'êtes pas obligé de comprendre son fonctionnement. Seulement            de savoir l'utiliser. Lorsque vous appelez <i>_writec</i> (<i><b>bl</b>              <b>_writec</b></i>), elle affiche dans le terminal de qemu le            caractère dont le code est dans le registre <i>r0</i>. Il suffira            d'initialiser la bonne valeur pour chacun des caractères et            d'appeler plusieurs fois la fonction pour afficher "HELLO WORLD".<br>            Pour vous guider un peu, voici les étapes que vous devez effectuer :          </p>          <ul>            <li>Ajoutez une règle pour compiler <i>io.s</i>. Un conseil :              Copiez-collez la règle de <i> start.o</i> et remplacer <i>start</i>              par <i>io</i></li>            <li>Ajoutez <i>io.o</i> dans la compilation de <i>kernel.bin</i>,              comme vous l'avez fait lorsque vous avez pour le fichier <i>div.o</i></li>            <li>Modifiez <i>start.s</i> pour qu'il appel la fonction <i>_writec</i>              de la même manière que nous avons appelé la fonction <i>div</i></li>            <li>Compilez pour vérifier que la fonction est bien accessible</li>            <li>Appelez plusieurs fois la fonction <i>_writec</i> de telle              sorte que le programme affiche "<i>HELLO WORLD</i>" à l'écran.              Pour cela, vous devez mettre dans le registre <i>r0</i>, la              valeur de chaque caractère, codé en ASCII avant chaque appel à <i>_writec</i>.              Pour connaitre le code de chaque caractère, utilisez le tableau              ci-dessous</li>          </ul>          <img src="http://www.asciitable.com/index/asciifull.gif">          <p></p>        </span>        <div id="footer"> © UFR IM2AG          <div id="bottom-links" style="float: right;"> <a href="../index.html">Home</a>          </div>        </div>      </div>    </div>  </body></html>